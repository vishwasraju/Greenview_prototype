<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Green View - Full-Featured Prototype</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Leaflet Map CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Leaflet Routing Machine CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #F9FAFB;
        }
        #app {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .fade-in {
            animation: fadeIn 0.6s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-bg {
            animation: fadeIn 0.3s ease-in-out;
        }
        .modal-content {
            animation: zoomIn 0.3s ease-in-out;
        }
        @keyframes zoomIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .btn-primary {
            background-color: #4f46e5;
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #6366f1;
        }
        #map-container {
            background-color: #1f2937;
            z-index: 0; /* Ensures map is interactive */
        }
        .leaflet-control-zoom-in, .leaflet-control-zoom-out {
            background-color: #374151 !important;
            color: white !important;
            border-color: #4b5563 !important;
        }
        .leaflet-control-zoom-in:hover, .leaflet-control-zoom-out:hover {
             background-color: #4b5563 !important;
        }
        .leaflet-popup-content-wrapper, .leaflet-popup-tip {
             background-color: #1f2937 !important;
             color: white !important;
             border-radius: 0.75rem !important;
             box-shadow: 0 4px 12px rgba(0,0,0,0.4) !important;
        }
        .leaflet-popup-content {
            margin: 1rem !important;
            width: auto !important;
            min-width: 240px !important;
        }
        .leaflet-popup-close-button {
            padding: 8px 8px 0 0 !important;
            color: #9ca3af !important;
        }
        /* Hide the default routing instructions panel */
        .leaflet-routing-container {
            display: none;
        }
        .deal-input {
             background-color: #374151;
             border: 1px solid #4b5563;
             border-radius: 0.375rem;
             color: #f9fafb;
             padding: 0.5rem 0.75rem;
             font-size: 0.875rem;
             width: 100%;
             transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .deal-input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.5);
        }
        .item-checkbox-label {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            background-color: #374151;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .item-checkbox-label:hover {
            background-color: #4b5563;
        }
        .item-checkbox:checked + .item-checkbox-label {
            background-color: #4f46e5;
            border-color: #6366f1;
        }
        .item-checkbox {
            display: none;
        }
        .filter-button.active {
            background-color: #10B981;
            color: white;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.5);
        }
        
        /* Fullscreen layout improvements */
        @media (min-width: 1280px) {
            .xl\\:col-span-1 {
                flex: 0 0 25%;
                max-width: 25%;
            }
            .xl\\:col-span-3 {
                flex: 0 0 75%;
                max-width: 75%;
            }
        }
        
        /* Ensure proper height calculations */
        html, body {
            height: 100%;
            overflow: hidden;
        }
        
        #app {
            height: 100vh;
        }
        
        /* Custom scrollbar for deals container */
        #deals-container::-webkit-scrollbar {
            width: 6px;
        }
        
        #deals-container::-webkit-scrollbar-track {
            background: #374151;
            border-radius: 3px;
        }
        
        #deals-container::-webkit-scrollbar-thumb {
            background: #6b7280;
            border-radius: 3px;
        }
        
        #deals-container::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
    </style>
</head>
<body class="bg-gray-900">

    <div id="app">
        <!-- App content is rendered here by JavaScript -->
    </div>
    <div id="modal-container"></div>

    <script>
        // --- MOCK DATA & STATE MANAGEMENT ---
        const PREDEFINED_ITEMS = {
            vegetable: ['Tomato', 'Potato', 'Onion', 'Carrot', 'Spinach', 'Cauliflower', 'Cabbage', 'Bell Pepper', 'Brinjal (Eggplant)', 'Okra (Lady Finger)', 'Cucumber', 'Ginger', 'Garlic', 'Green Chilli', 'Beans'],
            fruit: ['Mango', 'Banana', 'Apple', 'Orange', 'Grapes', 'Watermelon', 'Pineapple', 'Guava', 'Pomegranate'],
        };

        let state = {
            currentPage: 'landing', 
            isVendorLoggedIn: false,
            isSignupModalOpen: false,
            isAddItemModalOpen: false,
            activeFilter: 'all',
            searchTerm: '',
            deals: [
                { id: 1, vendor: 'Fresh Farms', ownerName: 'Ravi Kumar', phone: '9123456789', itemName: 'Tomatoes', category: 'vegetable', price: 35, quantity: '1kg', distance: 0.5, lat: 12.9810, lng: 77.6046 },
                { id: 2, vendor: 'Gupta Vegetables', ownerName: 'Sita Gupta', phone: '9234567890', itemName: 'Spinach', category: 'vegetable', price: 15, quantity: 'per bunch', distance: 1.2, lat: 12.9616, lng: 77.5846 },
                { id: 3, vendor: 'City Veggies', ownerName: 'Vijay Singh', phone: '9345678901', itemName: 'Mangoes', category: 'fruit', price: 80, quantity: '1kg', distance: 2.1, lat: 12.9750, lng: 77.6150 },
                { id: 4, vendor: 'The Green Cart', ownerName: 'Priya Patel', phone: '9456789012', itemName: 'Bell Peppers', category: 'vegetable', price: 50, quantity: '1kg', distance: 0.8, lat: 12.9650, lng: 77.6000 },
                { id: 6, vendor: 'Fruit Stand', ownerName: 'Amit Shah', phone: '9567890123', itemName: 'Bananas', category: 'fruit', price: 30, quantity: 'per dozen', distance: 0.5, lat: 12.9700, lng: 77.5900 },
            ],
            loggedInVendor: {
                shopName: 'My Veggie Stall',
                ownerName: 'Ankit Sharma',
                phone: '9876543210',
                location: 'Koramangala, Bengaluru',
                lat: 12.9309,
                lng: 77.6238
            },
            vendorDeals: [
                 { id: 5, vendor: 'My Veggie Stall', ownerName: 'Ankit Sharma', phone: '9876543210', itemName: 'Carrots', category: 'vegetable', price: 25, quantity: '1kg', lat: 12.9309, lng: 77.6238 }
            ],
        };

        let userLocation = null; // [lat, lon]
        let routingControl = null;

        function setState(newState) {
            Object.assign(state, newState);
            if (state.currentPage === 'buyer-app') {
                renderDeals();
            } else {
                renderApp();
            }
        }

        // --- NAVIGATION ---
        function navigate(page) {
            window.location.hash = page;
        }

        function handleHashChange() {
            const page = window.location.hash.substring(1) || 'landing';
            if (!state.isVendorLoggedIn && page === 'vendor-dashboard') {
                state.currentPage = 'vendor-login';
            } else {
                state.currentPage = page;
            }
            renderApp();
        }

        // --- MAP LOGIC ---
        let map = null;
        let mapVendorMarkers = {};

        function initMap(center = [15.3173, 75.7139], zoom = 7) { // Default to Karnataka view
            const mapContainer = document.getElementById('map-container');
            if (mapContainer && !map) {
                map = L.map(mapContainer).setView(center, zoom);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
                }).addTo(map);
            } else if (map) {
                 map.setView(center, zoom);
            }
        }
        
        function updateMapMarkers(deals) {
            if (!map) return;

            Object.values(mapVendorMarkers).forEach(marker => map.removeLayer(marker));
            mapVendorMarkers = {};

            const vendors = {};
            deals.forEach(deal => {
                if (!vendors[deal.vendor] && deal.lat && deal.lng) {
                    vendors[deal.vendor] = { lat: deal.lat, lng: deal.lng, deal: deal };
                }
            });

            for (const vendorName in vendors) {
                const vendor = vendors[vendorName];
                const marker = L.marker([vendor.lat, vendor.lng]).addTo(map);
                
                const popupContent = `
                    <div class="text-center">
                         <h3 class="text-lg font-bold text-white">${vendor.deal.vendor}</h3>
                         <p class="text-xs text-gray-400">Owner: ${vendor.deal.ownerName}</p>
                    </div>
                    <div class="space-y-1 text-sm mt-3">
                        <div class="flex justify-between items-center"><span class="font-semibold text-gray-300">Item:</span> <span class="text-white font-bold">${vendor.deal.itemName}</span></div>
                        <div class="flex justify-between items-center"><span class="font-semibold text-gray-300">Price:</span> <span class="text-emerald-400 font-bold">₹${vendor.deal.price} / ${vendor.deal.quantity}</span></div>
                    </div>
                    <a href="tel:${vendor.deal.phone}" class="mt-3 w-full bg-emerald-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-emerald-600 transition flex items-center justify-center space-x-2 text-sm">
                         <i data-lucide="phone" class="w-4 h-4"></i>
                         <span>Call: ${vendor.deal.phone}</span>
                    </a>
                `;

                marker.bindPopup(popupContent);
                mapVendorMarkers[vendorName] = marker;
            }
        }


        // --- GEOLOCATION ---
        function getLocation(inputId) {
            const statusEl = document.getElementById('location-status');
            if (navigator.geolocation) {
                if(statusEl) statusEl.textContent = 'Fetching location...';
                navigator.geolocation.getCurrentPosition(
                    (position) => showPosition(position, inputId),
                    (error) => {
                         if(statusEl) {
                            switch(error.code) {
                                case error.PERMISSION_DENIED: statusEl.textContent = "Location access denied."; break;
                                case error.POSITION_UNAVAILABLE: statusEl.textContent = "Location information is unavailable."; break;
                                case error.TIMEOUT: statusEl.textContent = "Location request timed out."; break;
                                default: statusEl.textContent = "An unknown error occurred."; break;
                            }
                         }
                    }
                );
            } else {
                if(statusEl) statusEl.textContent = "Geolocation is not supported by this browser.";
            }
        }

        async function showPosition(position, inputId) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const statusEl = document.getElementById('location-status');
            const inputEl = document.getElementById(inputId);

            try {
                if(statusEl) statusEl.textContent = 'Converting coordinates...';
                const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`);
                const data = await response.json();
                const locationString = `${data.locality}, ${data.principalSubdivision}`;
                if (inputEl) inputEl.value = locationString;
                if(statusEl) statusEl.textContent = '';
            } catch (error) {
                 if(statusEl) statusEl.textContent = 'Could not fetch address.';
                 console.error("Reverse geocoding failed:", error);
            }
        }
        
        function getBuyerLocationAndRender() {
            const locationEl = document.getElementById('user-location');
            if (!locationEl) return;

            const renderWithLocation = (lat, lon, text, zoom) => {
                userLocation = [lat, lon];
                locationEl.textContent = text;
                initMap([lat, lon], zoom);
                renderDeals();
            };

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const { latitude, longitude } = position.coords;
                        try {
                            const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=en`);
                            const data = await response.json();
                            renderWithLocation(latitude, longitude, `Deals near ${data.locality}, ${data.principalSubdivision}`, 18);
                        } catch (error) {
                            renderWithLocation(latitude, longitude, 'Your current location', 18);
                        }
                    },
                    () => {
                        renderWithLocation(15.3173, 75.7139, 'Location access denied. Showing deals in Karnataka.', 7);
                    }
                );
            } else {
                renderWithLocation(15.3173, 75.7139, "Geolocation not supported. Showing deals in Karnataka.", 7);
            }
        }


        // --- "COMPONENTS" ---

        const LandingPage = () => `
            <div class="min-h-screen flex flex-col fade-in">
                <nav class="p-6 flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                        <div class="bg-emerald-500 p-2 rounded-lg"><i data-lucide="leaf" class="text-white"></i></div>
                        <h1 class="text-2xl font-bold text-white">Green View</h1>
                    </div>
                    <div><button onclick="navigate('vendor-login')" class="btn-primary font-semibold py-2 px-5 rounded-full">Vendor Portal</button></div>
                </nav>
                <main class="flex-grow flex items-center">
                    <div class="container mx-auto px-6 py-12 text-center">
                        <div class="max-w-3xl mx-auto">
                            <h2 class="text-4xl md:text-6xl font-extrabold text-white leading-tight mb-6">Fresh Produce. Unbeatable Prices. <span class="text-emerald-400">Zero Waste.</span></h2>
                            <p class="text-lg md:text-xl text-gray-300 mb-10">Discover delicious, surplus fruits and vegetables from local vendors at amazing discounts. Eat fresh, save money, and help our planet.</p>
                            <button onclick="navigate('buyer-app')" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-4 px-10 rounded-full text-lg transition duration-300 transform hover:scale-105">Find Deals Near Me</button>
                        </div>
                    </div>
                </main>
                <footer class="text-center p-6 text-gray-500 text-sm">© 2024 Green View. A fresh approach to food.</footer>
            </div>
        `;

        const VendorLoginPage = () => `
             <div class="min-h-screen flex items-center justify-center p-4 fade-in">
                <div class="w-full max-w-md">
                    <div class="bg-gray-800 border border-gray-700 rounded-2xl p-8 shadow-2xl">
                        <div class="text-center mb-8">
                             <div class="flex justify-center items-center space-x-3 mb-4">
                                <div class="bg-emerald-500 p-2 rounded-lg"><i data-lucide="leaf" class="text-white"></i></div>
                                <h1 class="text-2xl font-bold text-white">Green View</h1>
                            </div>
                            <h2 class="text-xl font-bold text-white">Vendor Portal Login</h2>
                        </div>
                        <form id="vendor-login-form">
                            <div id="login-error" class="text-red-400 text-sm mb-4 text-center h-5"></div>
                            <div class="mb-4">
                                <input type="email" id="email" placeholder="Email address" required class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-emerald-500">
                            </div>
                            <div class="mb-6">
                                <input type="password" id="password" placeholder="Password" required class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-emerald-500">
                            </div>
                            <button type="submit" class="w-full btn-primary font-bold py-3 px-4 rounded-lg text-lg">Login</button>
                        </form>
                        <button onclick="handleTestLogin()" class="w-full mt-4 bg-gray-600 text-gray-200 font-bold py-3 px-4 rounded-lg hover:bg-gray-500 transition">Test Direct Entry</button>
                        <p class="text-center text-gray-400 text-sm mt-6">Not a vendor yet? <a href="#" onclick="event.preventDefault(); setState({ isSignupModalOpen: true })" class="font-medium text-emerald-400 hover:underline">Sign up</a></p>
                    </div>
                    <button onclick="navigate('landing')" class="w-full text-gray-400 hover:text-white mt-8 transition">← Back to Home</button>
                </div>
            </div>
        `;
        
        const VendorSignupModal = () => {
            if (!state.isSignupModalOpen) return '';
            return `
                <div class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50 p-4 modal-bg">
                    <div class="bg-gray-800 border border-gray-700 rounded-2xl p-8 shadow-2xl w-full max-w-md modal-content">
                        <div class="text-center mb-6">
                            <h2 class="text-2xl font-bold text-white">Create Vendor Account</h2>
                        </div>
                        <form id="vendor-signup-form">
                            <div id="signup-error" class="text-red-400 text-sm mb-4 text-center h-5"></div>
                            <div class="mb-4"><input type="text" id="shopName" placeholder="Shop Name" required class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-emerald-500"></div>
                            <div class="mb-4"><input type="text" id="ownerName" placeholder="Owner Name" required class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-emerald-500"></div>
                             <div class="mb-4"><input type="tel" id="phone" placeholder="Phone Number" required class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-emerald-500"></div>
                            <div class="mb-4"><input type="email" id="signup-email" placeholder="Email Address" required class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-emerald-500"></div>
                            <div class="mb-4">
                                <label for="shopLocation" class="block text-sm font-medium text-gray-300 mb-1">Shop Location</label>
                                <div class="flex space-x-2">
                                    <input type="text" id="shopLocation" placeholder="e.g., Koramangala, Bengaluru" required class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-emerald-500">
                                    <button type="button" onclick="getLocation('shopLocation')" class="p-3 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600 transition"><i data-lucide="map-pin" class="w-5 h-5"></i></button>
                                </div>
                                <p id="location-status" class="text-xs text-gray-400 mt-1 h-4"></p>
                            </div>
                            <div class="mb-6"><input type="password" id="signup-password" placeholder="Password" required class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-emerald-500"></div>
                            <div class="flex space-x-4">
                                <button type="button" onclick="setState({ isSignupModalOpen: false })" class="w-full bg-gray-600 text-gray-200 font-bold py-3 px-4 rounded-lg hover:bg-gray-500 transition">Cancel</button>
                                <button type="submit" class="w-full btn-primary font-bold py-3 px-4 rounded-lg">Create Account</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        };
        
        const AddItemModal = () => {
             if (!state.isAddItemModalOpen) return '';
             return `
                <div class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50 p-4 modal-bg">
                    <div id="add-item-modal-content" class="bg-gray-800 border border-gray-700 rounded-2xl p-8 shadow-2xl w-full max-w-lg modal-content">
                         <!-- Content will be injected by openAddItemModal -->
                    </div>
                </div>
             `
        }

        const BuyerAppPage = () => `
            <div class="w-full h-screen flex flex-col fade-in">
                 <nav class="flex justify-between items-center p-4 md:p-6 border-b border-gray-700 flex-shrink-0">
                    <div class="flex items-center space-x-3">
                        <div class="bg-emerald-500 p-2 rounded-lg"><i data-lucide="leaf" class="text-white"></i></div>
                        <h1 class="text-2xl font-bold text-white">Green View</h1>
                    </div>
                    <button onclick="navigate('landing')" class="text-gray-300 hover:text-white font-semibold py-2 px-4 rounded-full transition">← Back to Home</button>
                </nav>
                 <div class="flex items-center space-x-2 text-gray-400 p-4 md:p-6 pt-4 flex-shrink-0">
                    <i data-lucide="map-pin" class="w-4 h-4 text-emerald-400"></i>
                    <span id="user-location">Detecting your location...</span>
                </div>
                <main class="flex-1 overflow-hidden">
                    <div class="h-full grid grid-cols-1 xl:grid-cols-4 gap-6 p-4 md:p-6 pt-0">
                        <div class="xl:col-span-1 bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700 relative flex flex-col">
                            <h2 class="text-xl font-bold mb-4 text-white">Nearby Vendors</h2>
                            <div id="map-container" class="flex-1 w-full rounded-lg min-h-80"></div>
                        </div>
                        <div class="xl:col-span-3 space-y-4 flex flex-col">
                            <div class="flex flex-col lg:flex-row gap-4 flex-shrink-0">
                                <div class="relative flex-grow">
                                    <input type="text" id="search-input" oninput="handleSearch(this.value)" placeholder="Search for items..." class="w-full pl-10 pr-4 py-3 bg-gray-700 border border-gray-600 rounded-full text-white focus:outline-none focus:ring-2 focus:ring-emerald-500">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i data-lucide="search" class="w-5 h-5 text-gray-400"></i>
                                    </div>
                                </div>
                                <div class="flex items-center justify-center space-x-2 flex-shrink-0">
                                     <button id="filter-all" onclick="handleFilter('all')" class="py-2 px-4 rounded-full text-sm font-semibold transition filter-button">All</button>
                                     <button id="filter-fruit" onclick="handleFilter('fruit')" class="py-2 px-4 rounded-full text-sm font-semibold transition filter-button">Fruits</button>
                                     <button id="filter-vegetable" onclick="handleFilter('vegetable')" class="py-2 px-4 rounded-full text-sm font-semibold transition filter-button">Vegetables</button>
                                     <button id="filter-other" onclick="handleFilter('other')" class="py-2 px-4 rounded-full text-sm font-semibold transition filter-button">Other</button>
                                </div>
                             </div>
                            <h2 class="text-xl font-bold text-white pt-4 flex-shrink-0">Today's Top Deals</h2>
                            <div id="deals-container" class="space-y-4 overflow-y-auto flex-1 pb-4"></div>
                        </div>
                    </div>
                </main>
            </div>
        `;

        const VendorDashboardPage = () => `
            <div class="max-w-4xl mx-auto p-4 md:p-6 fade-in">
                <nav class="flex justify-between items-center mb-8">
                    <div class="flex items-center space-x-3">
                        <div class="bg-emerald-500 p-2 rounded-lg"><i data-lucide="leaf" class="text-white"></i></div>
                        <h1 class="text-2xl font-bold text-white">Vendor Dashboard</h1>
                    </div>
                    <button onclick="handleLogout()" class="font-semibold text-gray-300 hover:text-white py-2 px-4 rounded-full transition">Logout</button>
                </nav>
                <main>
                     <div class="bg-gray-700 p-4 rounded-lg mb-6 flex justify-between items-center">
                        <div>
                            <h3 class="text-xl font-bold">${state.loggedInVendor.shopName}</h3>
                            <p class="text-sm text-gray-400">${state.loggedInVendor.ownerName}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                             <i data-lucide="phone" class="w-5 h-5 text-emerald-400"></i>
                             <p class="text-lg font-semibold text-emerald-400">${state.loggedInVendor.phone}</p>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                         <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-white">Your Inventory</h2>
                            <div class="flex flex-wrap gap-2">
                               <button onclick="openAddItemModal('vegetable')" class="flex items-center space-x-2 bg-emerald-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-emerald-600 transition">
                                    <i data-lucide="plus" class="w-5 h-5"></i><span>Add Vegetable</span>
                               </button>
                               <button onclick="openAddItemModal('fruit')" class="flex items-center space-x-2 bg-sky-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-600 transition">
                                    <i data-lucide="plus" class="w-5 h-5"></i><span>Add Fruit</span>
                               </button>
                                <button onclick="addNewDeal(null, 'other', true)" class="flex items-center space-x-2 bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600 transition">
                                    <i data-lucide="plus" class="w-5 h-5"></i><span>Add Other</span>
                               </button>
                            </div>
                        </div>
                        <div id="vendor-deals-container" class="space-y-4">
                            <!-- Editable deal cards will be rendered here -->
                        </div>
                    </div>
                </main>
            </div>
        `;

        // --- RENDERING LOGIC ---
        function renderDeals() {
            const dealsContainer = document.getElementById('deals-container');
            if (!dealsContainer) return;

            dealsContainer.innerHTML = '';
            let allDeals = [...state.deals, ...state.vendorDeals];

            if (state.searchTerm) allDeals = allDeals.filter(deal => deal.itemName.toLowerCase().includes(state.searchTerm.toLowerCase()));
            if (state.activeFilter !== 'all') allDeals = allDeals.filter(deal => deal.category === state.activeFilter);
            
            allDeals.sort((a, b) => (a.distance - b.distance) || (a.price - b.price));

            if (allDeals.length === 0) {
                dealsContainer.innerHTML = `<div class="bg-gray-800 p-8 text-center rounded-xl border border-gray-700"><p class="text-gray-400">No deals found matching your criteria.</p></div>`;
            } else {
                 allDeals.forEach(deal => {
                    dealsContainer.innerHTML += `
                    <div class="bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700 hover:border-emerald-500 transition flex items-center space-x-4 cursor-pointer" onclick="handleDealClick(${deal.id})">
                        <div class="bg-emerald-900 bg-opacity-50 p-3 rounded-lg flex-shrink-0"><i data-lucide="shopping-basket" class="w-8 h-8 text-emerald-400"></i></div>
                        <div class="flex-grow">
                            <h3 class="font-bold text-lg text-white">${deal.itemName}</h3>
                            <p class="text-sm text-gray-400 font-medium">${deal.vendor} <span class="text-xs text-gray-500">(${deal.ownerName})</span></p>
                            <p class="text-xl font-bold text-emerald-400 mt-2">₹${deal.price}<span class="text-sm font-normal text-gray-400">/${deal.quantity}</span></p>
                        </div>
                        <div class="flex-shrink-0 text-right">
                            <p class="text-sm text-gray-400 font-semibold">${deal.distance} km</p>
                        </div>
                    </div>`;
                });
            }
            updateMapMarkers(allDeals);
            lucide.createIcons();
            
            document.querySelectorAll('.filter-button').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('bg-gray-600', 'hover:bg-gray-500', 'text-gray-200');
            });
            const activeButton = document.getElementById(`filter-${state.activeFilter}`);
            if (activeButton) {
                activeButton.classList.add('active');
                activeButton.classList.remove('bg-gray-600', 'hover:bg-gray-500', 'text-gray-200');
            }
        }

        function renderVendorDashboardContent() {
            const container = document.getElementById('vendor-deals-container');
            if (!container) return;
            
            if (state.vendorDeals.length === 0) {
                container.innerHTML = `<p class="text-gray-400 text-center py-8">Your inventory is empty. Add an item to get started!</p>`;
                return;
            }

            container.innerHTML = state.vendorDeals.map(deal => `
                <div class="bg-gray-700 p-4 rounded-lg flex flex-col md:flex-row md:items-center gap-4" id="deal-card-${deal.id}">
                    <div class="flex-grow">
                        <input type="text" id="item-name-${deal.id}" class="deal-input font-semibold text-lg mb-2" value="${deal.itemName}" placeholder="Item Name">
                        <select id="category-${deal.id}" class="deal-input text-sm">
                            <option value="vegetable" ${deal.category === 'vegetable' ? 'selected' : ''}>Vegetable</option>
                            <option value="fruit" ${deal.category === 'fruit' ? 'selected' : ''}>Fruit</option>
                            <option value="other" ${deal.category === 'other' ? 'selected' : ''}>Other</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2 flex-wrap">
                         <div class="flex-1 min-w-[100px]"><label class="text-xs text-gray-400">Price ₹</label><input type="number" id="price-${deal.id}" class="deal-input" value="${deal.price}" placeholder="e.g., 25"></div>
                         <div class="flex-1 min-w-[100px]"><label class="text-xs text-gray-400">Unit</label><input type="text" id="quantity-${deal.id}" class="deal-input" value="${deal.quantity}" placeholder="e.g., 1kg"></div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="saveDeal(${deal.id})" class="p-3 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600 transition"><i data-lucide="save" class="w-5 h-5"></i></button>
                        <button onclick="deleteDeal(${deal.id})" class="p-3 bg-gray-600 text-gray-300 rounded-lg hover:bg-red-500 hover:text-white transition"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                    </div>
                </div>`).join('');

            lucide.createIcons();
        }

        // --- EVENT HANDLERS & ACTIONS ---
        window.handleSearch = function(term) { setState({ searchTerm: term }); }
        window.handleFilter = function(category) { setState({ activeFilter: category }); }
        window.handleTestLogin = function() { setState({ isVendorLoggedIn: true }); navigate('vendor-dashboard'); }
        window.handleLogout = function() { setState({ isVendorLoggedIn: false }); navigate('landing'); }
        
        window.addNewDeal = function(name = '', category = 'other', isNew = false) {
             const newDeal = {
                id: Date.now(),
                vendor: state.loggedInVendor.shopName,
                ownerName: state.loggedInVendor.ownerName,
                phone: state.loggedInVendor.phone,
                itemName: name,
                category: category,
                price: '',
                quantity: '1kg',
                lat: state.loggedInVendor.lat,
                lng: state.loggedInVendor.lng
            };
            if (isNew) {
                 setState({ vendorDeals: [newDeal, ...state.vendorDeals] });
            } else {
                return newDeal;
            }
        }
        
        window.openAddItemModal = function(category) {
            setState({ isAddItemModalOpen: true });
            const modalContent = document.getElementById('add-item-modal-content');
            const items = PREDEFINED_ITEMS[category];
            modalContent.innerHTML = `
                <h2 class="text-2xl font-bold text-white mb-4">Add ${category.charAt(0).toUpperCase() + category.slice(1)}s</h2>
                <div id="item-selection-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-4 max-h-64 overflow-y-auto pr-2 mb-6">
                    ${items.map(item => `
                        <div>
                            <input type="checkbox" id="item-${item}" name="items" value="${item}" class="item-checkbox">
                            <label for="item-${item}" class="item-checkbox-label text-white">
                                <span class="ml-2">${item}</span>
                            </label>
                        </div>
                    `).join('')}
                </div>
                <div class="flex space-x-4">
                    <button type="button" onclick="setState({ isAddItemModalOpen: false })" class="w-full bg-gray-600 text-gray-200 font-bold py-3 px-4 rounded-lg hover:bg-gray-500 transition">Cancel</button>
                    <button type="button" onclick="addSelectedItems('${category}')" class="w-full btn-primary font-bold py-3 px-4 rounded-lg">Add Selected Items</button>
                </div>
            `;
            lucide.createIcons();
        }
        
        window.handleDealClick = function(dealId) {
            const deal = [...state.deals, ...state.vendorDeals].find(d => d.id === dealId);
            if (deal && map) {
                if (routingControl) {
                    map.removeControl(routingControl);
                }

                if (!userLocation) {
                    map.flyTo([deal.lat, deal.lng], 18);
                    const marker = mapVendorMarkers[deal.vendor];
                    if (marker) setTimeout(() => { marker.openPopup(); }, 500); 
                    return;
                }

                const waypoints = [ L.latLng(userLocation[0], userLocation[1]), L.latLng(deal.lat, deal.lng) ];

                routingControl = L.Routing.control({
                    waypoints: waypoints,
                    routeWhileDragging: false,
                    addWaypoints: false,
                    lineOptions: { styles: [{color: '#10B981', opacity: 0.8, weight: 6}] },
                    createMarker: function(i, waypoint, n) {
                         const markerIcon = i === 0 
                            ? L.divIcon({ className: 'bg-blue-500 rounded-full w-4 h-4 border-2 border-white', html: '', iconSize: [12, 12] })
                            : L.marker(waypoint.latLng).options.icon;
                         return L.marker(waypoint.latLng, { icon: markerIcon });
                    }
                }).addTo(map);

                const vendorMarker = mapVendorMarkers[deal.vendor];
                if(vendorMarker) {
                    map.flyTo([deal.lat, deal.lng], 18);
                    const popupContent = `
                        <div class="text-center">
                            <h3 class="text-lg font-bold text-white">${deal.vendor}</h3>
                            <p class="text-xs text-gray-400">Owner: ${deal.ownerName}</p>
                        </div>
                        <div class="space-y-1 text-sm mt-3">
                            <div class="flex justify-between items-center"><span class="font-semibold text-gray-300">Item:</span> <span class="text-white font-bold">${deal.itemName}</span></div>
                            <div class="flex justify-between items-center"><span class="font-semibold text-gray-300">Price:</span> <span class="text-emerald-400 font-bold">₹${deal.price} / ${deal.quantity}</span></div>
                        </div>
                        <a href="tel:${deal.phone}" class="mt-3 w-full bg-emerald-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-emerald-600 transition flex items-center justify-center space-x-2 text-sm">
                            <i data-lucide="phone" class="w-4 h-4"></i>
                            <span>Call: ${deal.phone}</span>
                        </a>
                    `;
                    setTimeout(() => {
                        vendorMarker.bindPopup(popupContent).openPopup();
                        lucide.createIcons();
                    }, 500);
                }
            }
        }

        window.addSelectedItems = function(category) {
            const selectedItems = [];
            document.querySelectorAll('#item-selection-grid input:checked').forEach(checkbox => {
                selectedItems.push(checkbox.value);
            });

            const newDeals = selectedItems.map(itemName => addNewDeal(itemName, category, false));

            setState({
                vendorDeals: [...newDeals, ...state.vendorDeals],
                isAddItemModalOpen: false
            });
        }


        window.saveDeal = function(id) {
            const updatedDeals = state.vendorDeals.map(deal => {
                if (deal.id === id) {
                    return {
                        ...deal,
                        itemName: document.getElementById(`item-name-${id}`).value,
                        category: document.getElementById(`category-${id}`).value,
                        price: parseFloat(document.getElementById(`price-${id}`).value) || 0,
                        quantity: document.getElementById(`quantity-${id}`).value,
                    };
                }
                return deal;
            });
            setState({ vendorDeals: updatedDeals });
            
            const card = document.getElementById(`deal-card-${id}`);
            if (card) {
                card.style.transition = 'all 0.2s ease';
                card.style.borderColor = '#34d399';
                card.style.boxShadow = '0 0 10px rgba(52, 211, 153, 0.3)';
                setTimeout(() => {
                    card.style.borderColor = '#4b5563';
                    card.style.boxShadow = 'none';
                }, 1000);
            }
        }

        window.deleteDeal = function(id) {
            const newVendorDeals = state.vendorDeals.filter(d => d.id !== id);
            setState({ vendorDeals: newVendorDeals });
        }
        
        function handleSignup(e) {
            e.preventDefault();
            const shopName = document.getElementById('shopName').value;
            const ownerName = document.getElementById('ownerName').value;
            const phone = document.getElementById('phone').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const shopLocation = document.getElementById('shopLocation').value;
            const errorDiv = document.getElementById('signup-error');

            if(shopName && ownerName && phone && email && password && shopLocation) {
                console.log(`New Vendor: ${shopName}, ${ownerName}, ${phone}`);
                setState({ 
                    isVendorLoggedIn: true, 
                    isSignupModalOpen: false, 
                    loggedInVendor: { shopName, ownerName, phone, location: shopLocation } 
                });
                navigate('vendor-dashboard');
            } else {
                errorDiv.textContent = 'Please fill out all fields.';
            }
        }
        
        function addEventListeners() {
            if(state.currentPage === 'vendor-login') {
                document.getElementById('vendor-login-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const email = document.getElementById('email').value;
                    const password = document.getElementById('password').value;
                    if (email === "vendor@example.com" && password === "password123") {
                        setState({ isVendorLoggedIn: true });
                        navigate('vendor-dashboard');
                    } else {
                        document.getElementById('login-error').textContent = 'Invalid credentials. Try vendor@example.com / password123';
                    }
                });
            }
            if(state.isSignupModalOpen) {
                 document.getElementById('vendor-signup-form').addEventListener('submit', handleSignup);
            }
        }
        
        // --- MAIN RENDER FUNCTION ---
        function renderApp() {
            const app = document.getElementById('app');
            const modalContainer = document.getElementById('modal-container');
            
            const currentPage = state.currentPage; // Cache current page
            
            if (app.innerHTML === '' || currentPage !== app.dataset.currentPage) {
                app.innerHTML = '';
                switch (currentPage) {
                    case 'landing': app.innerHTML = LandingPage(); break;
                    case 'vendor-login': app.innerHTML = VendorLoginPage(); break;
                    case 'vendor-dashboard': app.innerHTML = VendorDashboardPage(); break;
                    case 'buyer-app': app.innerHTML = BuyerAppPage(); break;
                    default: app.innerHTML = LandingPage();
                }
                app.dataset.currentPage = currentPage;
            }

            if (currentPage === 'vendor-dashboard') renderVendorDashboardContent();
            if (currentPage === 'buyer-app') {
                setTimeout(() => {
                    if(!map) getBuyerLocationAndRender();
                    else renderDeals();
                }, 0);
            }

            modalContainer.innerHTML = VendorSignupModal() + AddItemModal();
            
            lucide.createIcons();
            addEventListeners();
        }

        // --- INITIALIZATION ---
        window.addEventListener('hashchange', handleHashChange);
        document.addEventListener('DOMContentLoaded', () => { handleHashChange(); });

    </script>
</body>
</html>

